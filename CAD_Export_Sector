// Simcenter STAR-CCM+ macro: Sector_Extraction.java
// Written by Simcenter STAR-CCM+ 19.06.009
package macro;

import java.util.*;
import star.starice.*;
import star.common.*;
import star.base.neo.*;
import star.vis.*;
import star.cadmodeler.*;
import star.post.*;

public class Sector_Extraction extends StarMacro {

  public void execute() {
    execute0();
    execute1();
  }

  private void execute0() {
    Simulation simulation_0 = getActiveSimulation();

    // Get current simulation file path and name
    String simFilePath = simulation_0.getSessionPath(); // Full path
    String simFileName = simFilePath.substring(simFilePath.lastIndexOf("/") + 1); // e.g., P0.sim
    String prefix = simFileName.split("_")[0].replace(".sim", ""); // Extract prefix before underscore or remove .sim

    // Save simulation state with dynamic name
    simulation_0.saveState("/nfs/nnwork011/106300/03_Simulations/Sector/V2410/Designs/" + prefix + ".sim");
  }

  private void execute1() {
    Simulation simulation_0 = getActiveSimulation();

    simulation_0.get(SolutionHistoryManager.class).clear();

    Solution solution_0 = simulation_0.getSolution();
    solution_0.clearSolution();

    simulation_0.loadStarIce("StarIce");

    StarIceEngine starIceEngine_0 = simulation_0.get(StarIceEngine.class);
    starIceEngine_0.startStarIce();

    Scene scene_0 = simulation_0.getSceneManager().getScene("In-Cylinder");
    scene_0.setAdvancedRenderingEnabled(false);
    scene_0.openInteractive();

    simulation_0.loadStarIce("StarIce");

    ScalarGlobalParameter scalarGlobalParameter_0 =
      ((ScalarGlobalParameter) simulation_0.get(GlobalParameterManager.class).getObject("Start Angle"));

    CyclicTimeUnits cyclicTimeUnits_0 =
      ((CyclicTimeUnits) simulation_0.getUnitsManager().getObject("degCA"));

    starIceEngine_0.getEngineOperatingParameters().setParameter(scalarGlobalParameter_0, 720.0, cyclicTimeUnits_0, false);
    starIceEngine_0.updateStarIce();

    CadModel cadModel_0 =
      ((CadModel) simulation_0.get(SolidModelManager.class).getObject("In-Cylinder 3D-CAD 1"));

    star.cadmodeler.Body cadmodelerBody_0 =
      ((star.cadmodeler.Body) cadModel_0.getBody("Cylinder Sector: Sector Cylinder"));

    // Get prefix again for export file name
    String simFilePath = simulation_0.getSessionPath();
    String simFileName = simFilePath.substring(simFilePath.lastIndexOf("/") + 1);
    String prefix = simFileName.split("_")[0].replace(".sim", "");

    // Export CAD model with dynamic name
    cadModel_0.exportModel(
      new ArrayList<>(Arrays.<Body>asList(cadmodelerBody_0)),
      resolvePath("/nfs/nnwork011/106300/03_Simulations/Sector/V2410/Designs/" + prefix + ".x_b"),
      true, false, false, false, "0"
    );
  }
}
